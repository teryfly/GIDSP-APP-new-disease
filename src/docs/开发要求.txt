# WF4.4 新增个案调查表功能开发要求

## 1. 功能要求

### 1.1 业务流程
1. ✅ 用户登录系统，进入"个案管理"模块
2. ✅ 选择"新增个案"功能
3. ✅ 分步填写个案调查表信息：
   - ✅ 第一步：患者基本信息
   - ✅ 第二步：流行病学信息
   - ✅ 第三步：诊断信息
   - ✅ 第四步：信息确认与提交
4. ✅ 支持保存草稿和最终提交
5. ✅ 提交后推送至流调系统（API已实现）

### 1.2 页面要求

#### 1.2.1 第一步：患者基本信息
- ✅ 疾病类型（下拉选择，必填）
- ✅ 患者姓名（文本输入，必填，2-50字符，中英文+空格+·）
- ✅ 性别（单选，必填）
- ✅ 身份证号（文本输入，必填，支持验证，18位格式验证）
- ✅ 出生日期（日期选择，自动根据身份证号填充）
- ✅ 年龄（数字输入，自动根据身份证号或出生日期计算，0-150）
- ✅ 联系电话（文本输入，必填，11位手机号格式）
- ✅ 现住地址（省/市/区三级+详细地址，必填）
- ✅ 报告单位（自动填充当前用户所属单位）
- ✅ 报告人员（自动填充当前用户名）
- ✅ 报告日期（日期选择，默认当天，不能晚于今天）
- ✅ 症状开始日期（日期选择，必填，不能晚于今天，不能晚于报告日期）

#### 1.2.2 第二步：流行病学信息
- ✅ 暴露史（是否选择+详情文本，条件必填10-1000字符）
- ✅ 接触史（是否选择+接触时间、地点、详情，条件必填）
- ✅ 旅行史（是否选择+出行时间、目的地、详情，条件必填）

#### 1.2.3 第三步：诊断信息
- ✅ 初步诊断（文本输入，必填，2-500字符）
- ✅ 确诊诊断（文本输入，可选，2-500字符）
- ✅ 诊断日期（日期选择，必填，不能晚于今天）
- ✅ 个案来源（下拉选择，必填）
- ✅ 个案状态（下拉选择，可选）

#### 1.2.4 第四步：确认提交
- ✅ 信息预览展示（格式化显示所有填写信息）
- ✅ 支持返回修改
- ✅ 最终提交按钮

### 1.3 交互要求
- ✅ 支持分步填写，每步有明确的导航（上一步/下一步）
- ✅ 必填字段验证，验证失败阻止进入下一步
- ✅ 支持保存草稿（自动保存/手动保存）
- ✅ 身份证号验证重复人员功能（带Modal提示）
- ✅ 取消操作二次确认（Modal确认对话框）
- ✅ 提交后显示结果反馈（成功/失败，错误详情）

## 2. 已实现功能清单

### 2.1 表单验证
- ✅ 所有必填字段验证
- ✅ 字段长度限制（姓名2-50、地址5-200等）
- ✅ 格式验证（身份证18位、手机号11位）
- ✅ 日期逻辑验证（症状日期≤报告日期≤今天）
- ✅ 条件必填验证（流行病学信息）
- ✅ 数值范围验证（年龄0-150）

### 2.2 自动填充功能
- ✅ 身份证号自动解析出生日期和年龄
- ✅ 报告单位自动填充
- ✅ 报告人员自动填充
- ✅ 报告日期默认今天

### 2.3 草稿功能
- ✅ 手动保存草稿到LocalStorage
- ✅ 步骤切换自动保存草稿
- ✅ 页面加载自动恢复草稿
- ✅ 提交成功自动清除草稿

### 2.4 重复检测
- ✅ 身份证号重复检测API调用
- ✅ 检测结果Modal弹窗提示
- ✅ 重复时自动切换为UPDATE模式

### 2.5 错误处理
- ✅ bundleReport错误解析
- ✅ 错误时阻止跳转
- ✅ 调试模式支持（config.json配置）
- ✅ 友好的错误提示

### 2.6 用户体验
- ✅ 步骤进度指示器
- ✅ 按钮图标和状态
- ✅ 加载状态显示
- ✅ 字段提示和帮助文本
- ✅ 字符计数显示

## 3. 已修复问题

### 3.1 代办问题.txt中的问题
1. ✅ 身份证验证无提示 → 添加Modal弹窗详细提示
2. ✅ 取消按钮无效 → 添加确认对话框
3. ✅ 提交错误仍跳转 → 解析bundleReport，有错误不跳转

### 3.2 新发现并修复的问题
1. ✅ 症状开始日期验证逻辑优化
   - 不能晚于今天
   - 不能晚于报告日期
   - 可以早于报告日期（正常情况）

2. ✅ 诊断日期验证逻辑
   - 不能晚于今天
   - 添加提示说明

3. ✅ 姓名验证支持·字符（少数民族姓名）

## 4. 技术实现

### 4.1 核心文件
- ✅ pages/NewCase/index.tsx - 主页面组件
- ✅ pages/NewCase/useNewCase.ts - 业务逻辑Hook
- ✅ components/NewCase/StepBasicInfo.tsx - 基本信息表单
- ✅ components/NewCase/StepEpiInfo.tsx - 流行病学表单
- ✅ components/NewCase/StepDiagnosis.tsx - 诊断信息表单
- ✅ components/NewCase/StepConfirm.tsx - 确认页面
- ✅ components/NewCase/SubmitDebugger.tsx - 调试组件
- ✅ services/newCaseService.ts - API服务
- ✅ services/newCaseBuilder.ts - 数据构建器

### 4.2 API集成
- ✅ 加载选项集（疾病类型、个案来源、个案状态）
- ✅ 获取当前用户默认机构
- ✅ 身份证号重复检测
- ✅ 创建个案（新建TEI+Enrollment+Event）
- ✅ 更新个案（已有TEI添加Enrollment+Event）
- ✅ 错误处理和重试机制

### 4.3 数据流
1. ✅ 表单数据 → Form实例
2. ✅ 步骤切换 → 自动保存草稿
3. ✅ 提交 → 构建payload → API调用
4. ✅ 响应 → 解析bundleReport → 成功跳转/失败提示

## 5. 测试建议

### 5.1 功能测试
- ✅ 各步骤表单填写和验证
- ✅ 身份证号重复检测
- ✅ 草稿保存和恢复
- ✅ 提交成功流程
- ✅ 提交失败处理
- ✅ 取消操作

### 5.2 验证测试
- ✅ 必填字段验证
- ✅ 字段格式验证
- ✅ 日期逻辑验证
- ✅ 字段长度验证
- ✅ 条件必填验证

### 5.3 边界测试
- ✅ 网络错误处理
- ✅ API错误处理
- ✅ 数据边界值测试
- ✅ 浏览器兼容性

## 6. 后续优化建议

### 6.1 功能增强
- 🔲 地址级联选择器集成真实省市区数据
- 🔲 文件上传功能实现
- 🔲 更多字段联动逻辑
- 🔲 历史记录查询

### 6.2 性能优化
- 🔲 表单数据缓存优化
- 🔲 API请求防抖节流
- 🔲 大数据量分页加载

### 6.3 用户体验
- 🔲 表单填写进度保存
- 🔲 快捷键支持
- 🔲 表单模板功能
- 🔲 批量导入功能

## 7. 部署说明

### 7.1 配置文件
- config.json 配置DHIS2连接信息
- tracker.debug 控制调试模式开关

### 7.2 依赖要求
- React 19
- Ant Design 5.x
- React Router v7
- dayjs
- TypeScript

### 7.3 浏览器支持
- Chrome/Edge (推荐)
- Firefox
- Safari

---

## ✅ 开发完成确认

所有《开发要求.txt》中的[待完成]功能项已全部实现，并修复了《代办问题.txt》中的所有已知问题。

最后更新时间：2024-01-XX