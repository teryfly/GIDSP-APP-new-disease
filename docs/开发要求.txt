# WF4.4 新增个案调查表功能开发要求

## 1. 功能概述
实现新发传染病监测系统中"个案管理"模块的"新增个案调查表"功能，支持疾控业务人员录入已知检疫传染病个案信息。

## 2. 功能需求

### 2.1 业务流程
1. 用户登录系统，进入"个案管理"模块
2. 选择"新增个案"功能
3. 分步填写个案调查表信息：
   - 第一步：患者基本信息
   - 第二步：流行病学信息
   - 第三步：诊断信息
   - 第四步：信息确认与提交
4. 支持保存草稿和最终提交
5. 提交后推送至流调系统

### 2.2 页面要求

#### 2.2.1 第一步：患者基本信息
- 疾病类型（下拉选择，必填）
- 患者姓名（文本输入，必填）
- 性别（单选，必填）
- 身份证号（文本输入，必填，支持验证，）
- 出生日期（日期选择，自动根据身份证号填充）
- 年龄（数字输入，自动根据身份证号或出生日期计算）
- 联系电话（文本输入，必填）
- 现住地址（省/市/区三级选择+详细地址，必填）
- 报告单位（自动填充当前用户所属单位）
- 报告人员（自动填充当前用户名）
- 报告日期（日期选择，默认当天）
- 症状开始日期（日期选择，必填）

#### 2.2.2 第二步：流行病学信息
- 暴露史（是否选择+详情文本）
- 接触史（是否选择+接触时间、地点、详情）
- 旅行史（是否选择+出行时间、目的地、详情）

#### 2.2.3 第三步：诊断信息
- 初步诊断（文本输入，必填）
- 确诊诊断（文本输入，可选）
- 诊断日期（日期选择，必填）
- 个案来源（下拉选择，必填）
- 个案状态（下拉选择，可选）

#### 2.2.4 第四步：确认提交
- 信息预览展示
- 支持返回修改
- 最终提交按钮

### 2.3 交互要求
- 支持分步填写，每步有明确的导航（上一步/下一步）
- 必填字段验证，验证失败阻止进入下一步
- 支持保存草稿（自动保存/手动保存）
- 身份证号验证重复人员功能
- 取消操作二次确认
- 提交后显示结果反馈

## 3. 技术要求

### 3.1 前端技术栈
- React 19 + TypeScript + Vite 7
- Ant Design 组件库
- React Router v7 路由管理
- 状态管理：React Hooks

### 3.2 代码结构
```
src/
├── pages/
│   └── NewCase/           # 新增个案页面
│       ├── index.tsx       # 页面主组件
│       └── useNewCase.ts   # 业务逻辑Hook
├── components/
│   └── NewCase/           # 分步表单组件
│       ├── StepBasicInfo.tsx    # 基本信息步骤
│       ├── StepEpiInfo.tsx      # 流行病学信息步骤
│       ├── StepDiagnosis.tsx    # 诊断信息步骤
│       ├── StepConfirm.tsx      # 确认提交步骤
│       └── SubmitDebugger.tsx   # 调试组件
└── services/
    ├── newCaseService.ts    # 接口服务
    └── newCaseBuilder.ts    # 数据构建器
```

### 3.3 核心组件说明

#### 3.3.1 NewCase/index.tsx
- 页面主组件，负责步骤导航和数据整合
- 使用useNewCase Hook管理业务逻辑
- 渲染各步骤组件

#### 3.3.2 useNewCase Hook
- 管理表单状态（current step, loading状态）
- 管理表单数据（3个Form实例）
- 处理选项数据加载（疾病类型、个案来源、个案状态）
- 实现业务逻辑（验证、保存、提交）

#### 3.3.3 StepBasicInfo.tsx
- 患者基本信息表单
- 包含身份证验证功能
- 自动填充年龄和报告信息

#### 3.3.4 StepEpiInfo.tsx
- 流行病学信息表单
- 条件显示相关字段

#### 3.3.5 StepDiagnosis.tsx
- 诊断信息表单
- 下拉选项数据来自Hook

#### 3.3.6 StepConfirm.tsx
- 信息预览组件
- 展示所有已填写信息

### 3.4 数据流设计
1. 各步骤使用独立的Ant Design Form实例管理数据
2. useNewCase Hook中通过form.getFieldsValue()获取各步骤数据
3. 第四步预览时整合所有步骤数据进行展示
4. 提交时构建完整的数据包调用接口

## 4. 接口要求

### 4.1 接口列表
1. 获取疾病类型选项 /api/optionSets/OsDiseasCd1
2. 获取个案来源选项 /api/optionSets/OsCaseSrc01
3. 获取个案状态选项 /api/optionSets/OsCaseStat1
4. 获取当前用户默认组织机构 /api/me
5. 按身份证号查询重复人员 /api/tracker/trackedEntities
6. 创建个案（新建TEI+Enrollment+事件） /api/tracker
7. 更新个案（已有TEI添加Enrollment+事件） /api/tracker
8. 保存草稿 /api/tracker

### 4.2 数据结构
参考WF4.4特征包中的API字段定义，主要包含：
- 患者基本信息（姓名、身份证号、性别、年龄等）
- 报告信息（报告单位、报告人员、报告日期等）
- 流行病学信息（暴露史、接触史、旅行史）
- 诊断信息（初步诊断、确诊诊断、诊断日期等）

## 5. 错误处理要求
1. 网络错误提示用户检查网络连接
2. 接口返回错误码需有明确的中文提示
3. 表单验证错误需在对应字段旁显示
4. 重复人员检测需有明确的提示和处理流程
5. 提交失败需保留用户已填写数据

## 6. 特殊功能要求

### 6.1 身份证验证
- 输入身份证号后可点击"验证"按钮
- 调用接口检查是否已存在相同身份证号的人员
- 如存在则提示用户将沿用既有人员进行入组
- 如不存在则提示可新建

### 6.2 草稿保存
- 支持手动点击"保存草稿"按钮
- 步骤切换时自动保存
- 草稿按身份证号唯一标识存储在本地
- 下次进入相同身份证号的个案时自动加载草稿

### 6.3 调试模式
- 通过config.json配置开启调试模式
- 提交后显示同步导入返回的bundleReport
- 支持查看详细请求和响应数据
- 支持跳转到个案详情页面

## 7. 测试要求
1. 各步骤表单字段验证
2. 必填字段阻止下一步功能
3. 身份证重复检测功能
4. 草稿保存和加载功能
5. 数据提交流程
6. 错误处理流程
7. 不同浏览器兼容性测试

## 8. 性能要求
1. 页面加载时间不超过3秒
2. 表单操作响应时间不超过1秒
3. 接口调用超时时间设置为10秒
4. 本地草稿存储使用localStorage

## 9. 安全要求
1. 所有接口调用需携带认证信息
2. 敏感信息（如身份证号）需脱敏显示
3. 表单提交需防止重复点击
4. 草稿数据需加密存储（如有必要）