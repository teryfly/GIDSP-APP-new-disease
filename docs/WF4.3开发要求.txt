# WF4.3 个案查看编辑功能开发要求

## 1. 功能概述
实现新发传染病监测系统中"个案管理"模块的"个案查看编辑"功能，支持疾控业务人员查看、编辑已有的个案信息，包括基本信息、流行病学信息、随访记录、治疗记录、检测记录、追踪记录等。

## 2. 功能需求

### 2.1 业务流程
1. 用户登录系统，进入"个案管理"模块
2. 在个案列表中选择某个个案查看详情
3. 查看个案详细信息，包括：
   - 基本信息（患者信息、报告信息、诊断信息）
   - 流行病学信息（暴露史、接触史、旅行史）
   - 随访记录列表
   - 治疗记录列表
   - 检测记录列表
   - 追踪记录列表
   - 操作日志
4. 支持编辑个案基本信息
5. 支持新增/编辑随访记录、治疗记录、检测记录、追踪记录
6. 支持推送至流调系统
7. 支持结案操作

### 2.2 页面要求

#### 2.2.1 个案详情页布局
- 顶部：个案摘要信息（个案编号、状态、患者姓名、疾病、报告日期、报告人）
- 操作按钮：编辑、推送流调、结案、返回列表
- Tab导航：基本信息、流行病学、随访记录、治疗记录、检测记录、追踪记录、操作日志
- 主内容区：显示当前选中Tab的内容

#### 2.2.2 基本信息Tab
- 患者基本信息展示（姓名、性别、年龄、身份证号、联系电话、现住址）
- 报告信息展示（报告单位、报告人员、报告日期、症状开始日期、诊断日期）
- 诊断信息展示（初步诊断、确诊诊断、个案来源、个案状态）

#### 2.2.3 流行病学信息Tab
- 暴露史展示
- 接触史展示
- 旅行史展示

#### 2.2.4 随访记录Tab
- 随访记录列表，按时间倒序排列
- 每条记录显示：随访日期、随访方式、随访人员、健康状态、体温、症状、治疗依从性、下次随访日期
- 支持展开查看详细信息
- 支持新增随访记录
- 支持编辑已有随访记录

#### 2.2.5 治疗记录Tab
- 治疗记录列表，按时间倒序排列
- 每条记录显示：治疗日期、治疗方式、治疗药物、治疗剂量、治疗效果
- 支持新增治疗记录
- 支持编辑已有治疗记录

#### 2.2.6 检测记录Tab
- 检测记录列表，按时间倒序排列
- 每条记录显示：检测日期、检测编号、样本采集日期、样本类型、检测类型、检测结果、检测状态
- 显示推送至流调系统的状态
- 支持新增检测记录
- 支持编辑已有检测记录

#### 2.2.7 追踪记录Tab
- 追踪记录列表，按时间倒序排列
- 每条记录显示：追踪日期、追踪方式、追踪人员、追踪结果、追踪地点
- 支持新增追踪记录
- 支持编辑已有追踪记录

#### 2.2.8 操作日志Tab
- 操作日志列表，按时间倒序排列
- 每条记录显示：操作时间、操作人员、操作类型、操作内容
- 支持分页加载

### 2.3 交互要求
- Tab切换时动态加载对应内容
- 支持在详情页直接新增子记录（随访、治疗、检测、追踪）
- 编辑操作需有明确的保存和取消按钮
- 删除操作需二次确认
- 推送流调系统需二次确认
- 结案操作需二次确认
- 所有操作需有明确的成功/失败提示

## 3. 技术要求

### 3.1 前端技术栈
- React 19 + TypeScript + Vite 7
- Ant Design 组件库
- React Router v7 路由管理
- 状态管理：React Hooks

### 3.2 代码结构
```
src/
├── pages/
│   └── CaseDetail/              # 个案详情页面
│       ├── index.tsx             # 页面主组件
│       ├── useCaseDetail.ts      # 业务逻辑Hook
│       └── CaseDetailContext.ts  # 页面状态上下文
├── components/
│   └── CaseDetail/              # 详情页组件
│       ├── CaseHeader.tsx       # 个案头部信息
│       ├── CaseTabs.tsx         # Tab导航组件
│       ├── BasicInfoTab.tsx     # 基本信息Tab
│       ├── EpiInfoTab.tsx       # 流行病学信息Tab
│       ├── FollowUpTab.tsx      # 随访记录Tab
│       ├── TreatmentTab.tsx     # 治疗记录Tab
│       ├── TestTab.tsx          # 检测记录Tab
│       ├── TrackingTab.tsx      # 追踪记录Tab
│       ├── OperationLogTab.tsx  # 操作日志Tab
│       ├── FollowUpForm.tsx     # 随访记录表单
│       ├── TreatmentForm.tsx    # 治疗记录表单
│       ├── TestForm.tsx         # 检测记录表单
│       ├── TrackingForm.tsx     # 追踪记录表单
│       └── CaseActionButtons.tsx # 操作按钮组
└── services/
    └── caseDetailService.ts     # 接口服务
```

### 3.3 核心组件说明

#### 3.3.1 CaseDetail/index.tsx
- 页面主组件，负责整体布局和Tab切换
- 使用useCaseDetail Hook管理业务逻辑
- 使用CaseDetailContext管理页面状态

#### 3.3.2 useCaseDetail Hook
- 管理个案详情数据加载
- 管理各Tab数据的分页加载
- 处理编辑、新增、删除等操作
- 处理推送流调、结案等特殊操作

#### 3.3.3 CaseDetailContext.ts
- 提供页面级别的状态管理
- 共享个案基本信息给各子组件
- 管理当前激活的Tab

#### 3.3.4 各Tab组件
- BasicInfoTab.tsx：展示和编辑基本信息
- EpiInfoTab.tsx：展示流行病学信息
- FollowUpTab.tsx：展示随访记录列表，支持分页
- TreatmentTab.tsx：展示治疗记录列表，支持分页
- TestTab.tsx：展示检测记录列表，支持分页
- TrackingTab.tsx：展示追踪记录列表，支持分页
- OperationLogTab.tsx：展示操作日志列表，支持分页

#### 3.3.5 表单组件
- FollowUpForm.tsx：随访记录新增/编辑表单
- TreatmentForm.tsx：治疗记录新增/编辑表单
- TestForm.tsx：检测记录新增/编辑表单
- TrackingForm.tsx：追踪记录新增/编辑表单

### 3.4 数据流设计
1. 页面加载时通过个案ID获取个案详情数据
2. 各Tab根据需要动态加载数据（支持分页）
3. 编辑操作通过表单收集数据并调用接口更新
4. 新增子记录通过对应表单收集数据并调用接口创建
5. 删除操作调用对应接口删除记录
6. 特殊操作（推送流调、结案）调用对应接口执行

## 4. 接口要求

### 4.1 接口列表
1. 获取个案详情 /api/tracker/trackedEntities/{teiUid}
2. 获取随访记录列表 /api/tracker/events
3. 获取治疗记录列表 /api/tracker/events
4. 获取检测记录列表 /api/tracker/events
5. 获取追踪记录列表 /api/tracker/events
6. 获取操作日志 /api/tracker/events/{eventUid}/changeLogs
7. 更新个案基本信息 /api/tracker
8. 新增随访记录 /api/tracker
9. 更新随访记录 /api/tracker
10. 删除随访记录 /api/tracker
11. 新增治疗记录 /api/tracker
12. 更新治疗记录 /api/tracker
13. 删除治疗记录 /api/tracker
14. 新增检测记录 /api/tracker
15. 更新检测记录 /api/tracker
16. 删除检测记录 /api/tracker
17. 新增追踪记录 /api/tracker
18. 更新追踪记录 /api/tracker
19. 删除追踪记录 /api/tracker
20. 推送至流调系统 /api/tracker
21. 结案操作 /api/tracker
22. 获取选项集 /api/optionSets/{id}

### 4.2 数据结构
参考WF4.3特征包中的API字段定义，主要包含：
- 个案基本信息（个案编号、姓名、身份证号、性别、年龄等）
- 报告信息（报告单位、报告人员、报告日期等）
- 诊断信息（初步诊断、确诊诊断、个案来源、个案状态等）
- 流行病学信息（暴露史、接触史、旅行史）
- 随访记录（随访日期、随访方式、健康状态、体温等）
- 治疗记录（治疗日期、治疗方式、治疗药物等）
- 检测记录（检测日期、检测编号、样本类型、检测结果等）
- 追踪记录（追踪日期、追踪方式、追踪结果等）
- 操作日志（操作时间、操作人员、操作类型、操作内容等）

## 5. 错误处理要求
1. 网络错误提示用户检查网络连接
2. 接口返回错误码需有明确的中文提示
3. 表单验证错误需在对应字段旁显示
4. 删除操作失败需提示具体原因
5. 推送流调系统失败需提示具体原因并支持重试

## 6. 特殊功能要求

### 6.1 分页加载
- 随访记录、治疗记录、检测记录、追踪记录、操作日志均支持分页加载
- 默认每页显示10条记录
- 支持上拉加载更多

### 6.2 数据缓存
- 个案基本信息在页面内缓存，Tab切换时不重复请求
- 各Tab数据支持缓存，避免重复加载

### 6.3 权限控制
- 根据用户权限显示/隐藏编辑按钮
- 根据用户权限显示/隐藏推送流调按钮
- 根据用户权限显示/隐藏结案按钮

### 6.4 调试模式
- 通过config.json配置开启调试模式
- 显示接口请求和响应详细信息
- 支持查看数据结构

## 7. 测试要求
1. 个案详情数据正确展示
2. 各Tab数据正确加载和分页
3. 编辑功能正常工作
4. 新增子记录功能正常工作
5. 删除功能正常工作
6. 推送流调系统功能正常工作
7. 结案功能正常工作
8. 错误处理流程
9. 不同浏览器兼容性测试

## 8. 性能要求
1. 页面加载时间不超过3秒
2. Tab切换响应时间不超过1秒
3. 接口调用超时时间设置为10秒
4. 分页数据加载使用懒加载

## 9. 安全要求
1. 所有接口调用需携带认证信息
2. 敏感信息（如身份证号）需脱敏显示
3. 表单提交需防止重复点击
4. 删除操作需防止误操作