根据设计文档分析，预警信息的完整流程如下：

------

## 📋 预警信息生成与查询完整流程

### 1️⃣ **预警触发条件**

预警信息不是直接录入的，而是由**系统自动检测**生成。根据设计文档，触发预警的条件包括：

#### 📌 触发场景示例：

- **病例聚集**：7天内同地区同疾病病例数 > 阈值
- **异常症状**：出现罕见症状组合
- **新发疾病**：检测到未知病原体

#### 📌 触发机制：

预警由 **DHIS2 规则引擎（Program Rules）** 或 **外部预警系统** 触发后推送到DHIS2

------

### 2️⃣ **预警数据存储位置**

根据设计，预警信息可能存储在以下位置：

#### 方案A：使用 **Event Program**（推荐）

```
Program: "预警事件管理" (Event Program)
ProgramStage: "预警记录"
```

#### 方案B：使用 **Tracker Program**

```
Program: "已知疾病个案管理" 或 "不明原因疾病管理"
通过 Program Rules 触发特殊事件
```

根据 **State Machine SM-2.1**，预警事件有独立的状态流转：

```
待处理 → 处理中 → 已核实/误报 → 已关闭
```

------

### 3️⃣ **必须字段映射**

要能被 **API-06** 查询到，预警事件必须包含以下字段：

| DHIS2 字段     | 对应业务字段    | 必填 | 说明                     |
| -------------- | --------------- | ---- | ------------------------ |
| `program`      | 预警管理程序UID | ✅    | 固定值                   |
| `programStage` | 预警记录阶段UID | ✅    | 固定值                   |
| `orgUnit`      | 发生地区        | ✅    | 组织单位UID              |
| `occurredAt`   | 检测时间        | ✅    | 预警触发时间             |
| `status`       | 预警状态        | ✅    | `ACTIVE`, `COMPLETED` 等 |
| `dataValues`   | 预警详细信息    | ✅    | 见下表                   |

#### 📊 dataValues 必须包含的数据元素：

| DataElement UID  | 业务字段   | 必填 | 示例值                  |
| ---------------- | ---------- | ---- | ----------------------- |
| `DeAlertType`    | 预警类型   | ✅    | `病例聚集`              |
| `DeAlertLevel`   | 预警等级   | ✅    | `一级`（红色）          |
| `DeRelatedCase`  | 关联病例数 | ✅    | `5`                     |
| `DeAlertRule`    | 触发规则   | ✅    | `7天内同地区同疾病>5例` |
| `DeAlertSummary` | 预警摘要   | ✅    | `朝阳区XX街道近7天...`  |
| `DeAlertStatus`  | 处理状态   | ✅    | `待处理`                |

------

### 4️⃣ **完整流程示例**

#### 🔹 步骤1：病例数据录入

```
POST /api/tracker
{
  "trackedEntities": [{
    "trackedEntityType": "Person",
    "orgUnit": "DiszpKrYNg8", // 北京市朝阳区
    "enrollments": [{
      "program": "PrgCaseMgt1", // 已知疾病个案管理
      "enrolledAt": "2024-01-15",
      "events": [{
        "programStage": "PsInvestig1", // 个案调查
        "dataValues": [
          {"dataElement": "DeCaseStat1", "value": "已核实"},
          {"dataElement": "DiseaseCode", "value": "B03"} // 新冠肺炎
        ]
      }]
    }]
  }]
}
```

#### 🔹 步骤2：系统自动触发预警

当7天内同地区新冠病例 ≥ 5例时，**后台任务**自动创建预警事件：

```
POST /api/events
{
  "program": "AlertProgram",
  "programStage": "AlertStage",
  "orgUnit": "DiszpKrYNg8",
  "occurredAt": "2024-01-15T10:30:00",
  "status": "ACTIVE",
  "dataValues": [
    {"dataElement": "DeAlertType", "value": "病例聚集"},
    {"dataElement": "DeAlertLevel", "value": "一级"},
    {"dataElement": "DeRelatedCase", "value": "5"},
    {"dataElement": "DeAlertRule", "value": "7天内同地区同疾病>5例"},
    {"dataElement": "DeAlertSummary", "value": "朝阳区XX街道近7天内发现5例新冠肺炎确诊病例..."},
    {"dataElement": "DeAlertStatus", "value": "待处理"}
  ]
}
```

#### 🔹 步骤3：前端查询预警列表

```
GET /api/events?program=AlertProgram&orgUnit=DiszpKrYNg8&orgUnitMode=DESCENDANTS&filter=DeAlertStatus:eq:待处理&order=occurredAt:desc
```

#### 🔹 步骤4：用户处理预警

```
PUT /api/events/{alertEventUid}
{
  "dataValues": [
    {"dataElement": "DeAlertStatus", "value": "处理中"},
    {"dataElement": "DeProcessor", "value": "UserUID"},
    {"dataElement": "DeProcessTime", "value": "2024-01-15T14:20:00"}
  ]
}
```

#### 🔹 步骤5：关闭预警

```
PUT /api/events/{alertEventUid}
{
  "status": "COMPLETED",
  "dataValues": [
    {"dataElement": "DeAlertStatus", "value": "已核实"},
    {"dataElement": "DeProcessResult", "value": "已立案处理"}
  ]
}
```

------

### 5️⃣ **关键配置要求**

#### ✅ 必须完成的配置：

1. **创建预警管理程序**

   ```
   Program: "预警事件管理"
   Program Type: Event (without registration)
   ```

2. **定义预警数据元素**

   - 预警类型 (Option Set: 病例聚集/异常症状/新发疾病)
   - 预警等级 (Option Set: 一级/二级/三级)
   - 关联病例数 (Integer)
   - 触发规则 (Text)
   - 预警摘要 (Long Text)
   - 处理状态 (Option Set: 待处理/处理中/已核实/误报/已关闭)

3. **配置自动触发规则**

   - 方式1：DHIS2 Program Rules + Server-side Program Rules
   - 方式2：外部 ETL 任务定期扫描病例数据
   - 方式3：DHIS2 Analytics API + 定时任务

------

### 6️⃣ **验证查询条件**

#### 确保以下条件满足才能查询到预警：

| 条件                   | 检查方法                                        |
| ---------------------- | ----------------------------------------------- |
| ✅ 预警程序已创建       | `GET /api/programs?filter=name:eq:预警事件管理` |
| ✅ 用户有程序访问权限   | 检查 Sharing Settings                           |
| ✅ 组织单位在用户范围内 | `orgUnitMode=ACCESSIBLE` 或 `DESCENDANTS`       |
| ✅ 预警事件已创建       | `GET /api/events?program=AlertProgram`          |
| ✅ dataValues 字段完整  | 检查必填字段是否都有值                          |
| ✅ 时间范围正确         | `occurredAfter` 和 `occurredBefore` 参数        |

------

## 🎯 总结

要在 **WF-4.7 预警列表页** 查询到预警信息，需要：

1. **病例数据** → 通过 Tracker Program 录入
2. **触发规则** → 系统自动检测（Program Rules 或外部任务）
3. **预警事件** → 自动创建到 Event Program
4. **API查询** → 使用 `filter` 参数按状态、时间、地区筛选

**核心逻辑**：
 预警不是手工录入的，而是**被动生成**的。前端只负责**查询、展示和处理**预警事件，不负责创建预警。